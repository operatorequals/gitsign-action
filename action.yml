name: 'Gitsign Verify'

description: 'Uses `gitsign` to verify commit signatures of a branch'

inputs:
  version:
    description: 'Version of `gitsign` binary'
    required: true
    default: '0.3.1'

  main-branch:
    description: 'Git branch to check against'
    required: true
    default: 'master'

# outputs:
#   random-number:
#     description: "Random number"
#     value: ${{ steps.random-number-generator.outputs.random-number }}

runs:
  using: "composite"
  steps:

    - run: echo "${{ github.action_path }}" >> $GITHUB_PATH
      shell: bash

    - name: Install Gitsign
      shell: bash
      run: |
        # Get binary
        wget -q https://github.com/sigstore/gitsign/releases/download/v${{ inputs.version }}/gitsign_${{ inputs.version }}_linux_amd64 -O gitsign

        # Set gitsign as git commit verifier
        git config --local gpg.x509.program $(pwd)/gitsign
        git config --local gpg.format x509

    - name: Verify Commits
      shell: bash
      run: |
        for commit in $(git rev-list  ${{ inputs.main-branch }}..HEAD); do
          ./verify-commit.sh "$commit"
          EXIT_CODE="$?"

          if [ $EXIT_CODE != "0" ]; then
            echo "A commit was found without a signature or with an invalid one"
            echo "Use the following command to automatically resign your branch:"
            echo "    git rebase ${{ inputs.main-branch }} -x 'git commit --allow-empty --amend -S --no-edit'"
            break
          fi
        done
